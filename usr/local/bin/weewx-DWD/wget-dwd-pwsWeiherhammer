#!/bin/bash
# Herunterladen von Dateien beim Deutschen Wetterdienst
# Copyright (C) 2021 Johanna Roedenbeck
# licensed under the terms of the General Public License (GPL) v3
# 17.10.2022 Henry Ott
#            mehrere Ausgabepfade

# vom Benutzer anzupassen

# URLs der herunterzuladenden Dateien beim DWD
# (muss ggf. an das eigene Bundesland angepasst werden)
DWD_URL="https://opendata.dwd.de/weather/text_forecasts/html"
#DWD_BUNDESLAND="DWLG"
DWD_BUNDESLAND="DWMG"
DWD_MAP="https://www.dwd.de/DWD/wetter/wv_spez/hobbymet/wetterkarten/bwk_bodendruck_na_ana.png"
DWD_MAP2="https://www.dwd.de/DWD/wetter/wv_spez/hobbymet/wetterkarten/bwk_bodendruck_weu_ana.png"
#DWD_WARN="https://www.dwd.de/DWD/warnungen/warnstatus/SchilderLZ.jpg"
DWD_WARN="https://www.dwd.de/DWD/warnungen/warnstatus/SchilderMS.jpg"
DWD_WARNJ="https://www.dwd.de/DWD/warnungen/warnapp/json/warnings.json"

# Log-Datei
LOG_FN="/var/log/weewx/wget-dwd.log"

# Zielpfad(e) zum Speichern der Dateien
# (Das Verzeichnis muss vorher vom Benutzer angelegt werden.)
# PTH="/etc/weewx/skins/Belchertown/dwd"
EXPORTS=(
"/home/weewx/skins/Belchertown/dwd"
"/home/weewx/skins/weewx-wdc/dwd"
)

# Ende des vom Benutzer anzupassenden Bereichs

# Programm zum Herunterladen
WGET="/usr/bin/wget"
TOUCH="/usr/bin/touch"
MV="/usr/bin/mv"
CP="/usr/bin/cp"
RM="/usr/bin/rm"
TMP="/tmp/wget-dwd.tmp"
HTML2ENT="/usr/local/bin/weewx-DWD/html2ent.ansi"

# Logdatei loeschen
#/bin/rm "$LOG_FN" 2>/dev/null

# Herunterladen der Vorhersage-Dateien und Zeichensatz konvertieren
for i in 50 51 52 53 54; do
    FN="VHDL${i}_${DWD_BUNDESLAND}_LATEST"
    $WGET -a "${LOG_FN}" -O "${TMP}" "${DWD_URL}/${FN}_html"
    #sed -i 's/WIND\/STURM:/<br><br><strong>WIND\/STURM:<\/strong><br>/' "${TMP}"
    #sed -i 's/WIND:/<br><br><strong>WIND:<\/strong><br>/' "${TMP}"
    #sed -i 's/GEWITTER:/<br><br><strong>GEWITTER:<\/strong><br>/' "${TMP}"
    #sed -i 's/NEBEL:/<br><br><strong>NEBEL:<\/strong><br>/' "${TMP}"
    #sed -i 's/FROST:/<br><br><strong>FROST:<\/strong><br>/' "${TMP}"
    #sed -i 's/GLÄTTE:/<br><br><strong>GLÄTTE:<\/strong><br>/' "${TMP}"

    #TODO: alle Merkmale
    sed -i 's/WIND\/STURM:/<br><br><strong>Wind\/Sturm:<\/strong>/' "${TMP}"
    sed -i 's/WIND:/<br><br><strong>Wind:<\/strong>/' "${TMP}"
    sed -i 's/GEWITTER:/<br><br><strong>Gewitter:<\/strong>/' "${TMP}"
    sed -i 's/NEBEL:/<br><br><strong>Nebel:<\/strong>/' "${TMP}"
    sed -i 's/FROST:/<br><br><strong>Frost:<\/strong>/' "${TMP}"
    sed -i 's/GLÄTTE:/<br><br><strong>Glätte:<\/strong>/' "${TMP}"

    #sed -i 's/WIND\/STURM:/<br><br>WIND\/STURM:<br>/' "${TMP}"
    #sed -i 's/WIND:/<br><br>WIND:<br>/' "${TMP}"
    #sed -i 's/GEWITTER:/<br><br>GEWITTER:<br>/' "${TMP}"
    #sed -i 's/NEBEL:/<br><br>NEBEL:<br>/' "${TMP}"
    #sed -i 's/FROST:/<br><br>FROST:<br>/' "${TMP}"
    #sed -i 's/GLÄTTE:/<br><br>GLÄTTE:<br>/' "${TMP}"

    #sed -i 's/WIND\/STURM:/<br><br>Wind\/Sturm:<br>/' "${TMP}"
    #sed -i 's/WIND:/<br><br>Wind:<br>/' "${TMP}"
    #sed -i 's/GEWITTER:/<br><br>Gewitter:<br>/' "${TMP}"
    #sed -i 's/NEBEL:/<br><br>Nebel:<br>/' "${TMP}"
    #sed -i 's/FROST:/<br><br>Frost:<br>/' "${TMP}"
    #sed -i 's/GLÄTTE:/<br><br>Glätte:<br>/' "${TMP}"
    if [ "$?" -eq 0 ]; then
        for EXPORT in ${EXPORTS[@]}; do
            ${HTML2ENT} <"${TMP}" >"${EXPORT}/${FN}.html"
            ${TOUCH} -r "${TMP}" "${EXPORT}/${FN}.html"
        done
        rm "${TMP}"
    fi
done

# Herunterladen der uebrigen Dateien
$WGET -a "$LOG_FN" -O "/tmp/${DWD_MAP##*/}" ${DWD_MAP}
$WGET -a "$LOG_FN" -O "/tmp/${DWD_MAP2##*/}" ${DWD_MAP2}
$WGET -a "$LOG_FN" -O "/tmp/${DWD_WARN##*/}" ${DWD_WARN}
$WGET -a "$LOG_FN" -O "/tmp/${DWD_WARNJ##*/}" ${DWD_WARNJ}
for EXPORT in ${EXPORTS[@]}; do
    ${CP} -fv "/tmp/${DWD_MAP##*/}" ${EXPORT}/
    ${CP} -fv "/tmp/${DWD_MAP2##*/}" ${EXPORT}/
    ${CP} -fv "/tmp/${DWD_WARN##*/}" ${EXPORT}/
    ${CP} -fv "/tmp/${DWD_WARNJ##*/}" ${EXPORT}/
done
${RM} -fv "/tmp/${DWD_MAP##*/}"
${RM} -fv "/tmp/${DWD_MAP2##*/}"
${RM} -fv "/tmp/${DWD_WARN##*/}"
${RM} -fv "/tmp/${DWD_WARNJ##*/}"


